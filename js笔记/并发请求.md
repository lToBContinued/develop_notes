# 并发请求

```js
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>并发请求控制</title>
</head>
<body>
  <script>
    /**
     * @description 并发请求
     * @param {Array} urls 待请求的url数组
     * @param {number} maxNum 最大并发数
     * @return {Promise}
     */
    function concurRequest(urls, maxNum) {
      // 如果传进来的数组为空，直接返回空数组的Promise对象
      if (urls.length === 0) {
        return Promise.resolve([])
      }
      return new Promise((resolve) => {
        let nextIndex = 0 // 下一个请求的索引
        let finishCount = 0 // 完成的请求数量
        const result = [] // 放置请求结果的数组
        
        async function _request() {
          if (nextIndex >= urls.length) {
            return
          }
          const i = nextIndex // 记录当前请求的索引
          const url = urls[nextIndex++] // 下一次请求的url
          // 由于请求返回来的顺序和请求的顺序不一定相同，所以需要记录请求的索引，然后在请求返回后，将请求结果放到对应的位置
          result[i] = await fetch(url)
          finishCount++
          if (finishCount === urls.length) { // 所有请求都完成了，返回结果
            resolve(result)
          }
          _request() // 递归调用下一个请求补位
          console.log(result) // TODO:删除log
        }
        
        for (let i = 0; i < Math.min(maxNum, urls.length); i++) { // 并发个数
          _request()
        }
      })
    }
    
    const urls = []
    for (let i = 1; i <= 20; i++) {
      urls.push(`https://jsonplaceholder.typicode.com/todos/${ i }`)
    }
    concurRequest(urls, 5).then(res => {
      console.log(res)
    })
  </script>
</body>
</html>
```
